rules_version = '2';

/**
 * Firestore Security Rules for SitePilot Multi-Tenant Architecture
 * 
 * CRITICAL: These rules enforce strict tenant isolation
 * Each tenant's data is completely isolated from other tenants
 * 
 * Structure:
 * /tenants/{tenantId}/sites/{siteId}/...
 * 
 * Deploy these rules using Firebase CLI:
 * firebase deploy --only firestore:rules
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: Check if user belongs to tenant
    function belongsToTenant(tenantId) {
      return isAuthenticated() && 
             request.auth.token.tenantId == tenantId;
    }
    
    // Helper function: Validate tenant ID in document
    function hasValidTenantId(tenantId) {
      return request.resource.data.tenantId == tenantId;
    }
    
    // Root level - deny all direct access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Tenant collection - isolated per tenant
    match /tenants/{tenantId} {
      // Only allow read if user belongs to tenant
      allow read: if belongsToTenant(tenantId);
      
      // Only backend service account can write
      allow write: if false;
      
      // Sites subcollection
      match /sites/{siteId} {
        // Allow read if user belongs to tenant
        allow read: if belongsToTenant(tenantId);
        
        // Only backend service account can write
        allow write: if false;
        
        // Pages subcollection - public read for published sites
        match /pages/published/{pageId} {
          // Public read access for published pages
          allow read: if true;
          
          // Only backend can write
          allow write: if false;
        }
        
        // Forms subcollection - allow submissions
        match /forms/{formId} {
          // Allow read if user belongs to tenant
          allow read: if belongsToTenant(tenantId);
          
          // Allow form submissions (must include tenantId and siteId)
          allow create: if hasValidTenantId(tenantId) &&
                          request.resource.data.siteId == siteId &&
                          request.resource.data.submittedAt is timestamp;
          
          // No updates or deletes from client
          allow update, delete: if false;
        }
        
        // Analytics subcollection
        match /analytics/{analyticsId} {
          // Allow read if user belongs to tenant
          allow read: if belongsToTenant(tenantId);
          
          // Allow analytics events (must include tenantId and siteId)
          allow create: if hasValidTenantId(tenantId) &&
                          request.resource.data.siteId == siteId &&
                          request.resource.data.timestamp is timestamp;
          
          // No updates or deletes from client
          allow update, delete: if false;
        }
        
        // Dynamic content subcollection
        match /content/{contentId} {
          // Public read for published content
          allow read: if true;
          
          // Only backend can write
          allow write: if false;
        }
      }
    }
    
    // Admin collection - only accessible by backend service account
    match /admin/{document=**} {
      allow read, write: if false;
    }
    
    // System collection - only accessible by backend service account
    match /system/{document=**} {
      allow read, write: if false;
    }
  }
}

/**
 * DEPLOYMENT INSTRUCTIONS:
 * 
 * 1. Install Firebase CLI:
 *    npm install -g firebase-tools
 * 
 * 2. Login to Firebase:
 *    firebase login
 * 
 * 3. Initialize Firebase in your project:
 *    firebase init firestore
 * 
 * 4. Copy this file to firestore.rules in your project root
 * 
 * 5. Deploy rules:
 *    firebase deploy --only firestore:rules
 * 
 * 6. Verify rules in Firebase Console:
 *    https://console.firebase.google.com/project/YOUR_PROJECT/firestore/rules
 * 
 * TESTING:
 * 
 * Use Firebase Emulator Suite for local testing:
 * firebase emulators:start --only firestore
 * 
 * SECURITY NOTES:
 * 
 * - All tenant data is isolated by tenantId
 * - Cross-tenant reads/writes are impossible
 * - Public pages are readable by anyone
 * - Form submissions require valid tenantId and siteId
 * - Only backend service account can write to most collections
 * - Custom auth tokens should include tenantId claim
 */
